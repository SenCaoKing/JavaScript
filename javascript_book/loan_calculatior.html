<!DOCTYPE html>
<html>
<head>
<title>JavaScript Loan Calculation</title>
<style>
.output { font-weight: bold;} /* 计算结果定义为粗体 */
#payment { text-decoration: underline; }
#graph{ border: solid black 1px; }
th, td { vertical-align: top; }
</style>
</head>
<body>
<table>
	<tr>
		<th>Enter Loan Data:</th>
		<td></td>
		<th>Loan Balance, Cumulative Equity, and Interest Payments</th>
	</tr>
	<tr>
		<td>Amount of the loan ($):</td>
		<td><input id="amount" onchange="" /></td>
		<td rowspan="8">
			<canvas id="graph" width="400" heigth="250"></canvas>
		</td>
	</tr>
	<tr>
		<td>Annual interest (%):</td>
		<td><input id="apr" onchange="" /></td>
	</tr>
	<tr>
		<td>Repayment period (years):</td>
		<td><input id="years" onchange="" /></td>
	</tr>
	<tr>
		<td>Zipcode (to find lenders):</td>
		<td><input id="zipcode" onchange="" /></td>
	</tr>
	<tr>
		<th>Approximate Payments:</th>
		<td><button conclick="">Calculate</button></td>
	</tr>
	<tr>
		<td>Monthly payment:</td>
		<td>$<span class="output" id="payment"></span></td>
	</tr>
	<tr>
		<td>Total payment:</td>
		<td>$<span class="output" id="total"></span></td>
	</tr>
	<tr>
		<td>Total interest:</td>
		<td>$<span class="output" id="totalinterest"></span></td>
	</tr>
	<tr>
		<th>Sponsors:</th>
		<td colspan=2>
			Apply for your loan with one of these fine lenders:
			<div id="lenders"></div>
		</td>
	</tr>
</table>
<script>
"use strict"; // 如果浏览器支持的话，则开启ECMAScript 5的严格模式
/**
 * 这里的脚本定义了calculate()函数，在HTML代码中绑定事件处理程序时会调用它
 * 这个函数从<input>元素中读取数据，计算贷款赔付信息，并将结果显示在<span>元素中
 * 同样，这里还保存了用户数据、展示了放贷人链接并绘制出了图表
 */
function calculate() {
	// 查找文档中用于输入输出的元素
	var amount = document.getElementById("amount");
	var apr = document.getElementById("apr");
	var years = document.getElementById("years");
	var zipcode = document.getElementById("zipcode");
	var payment = document.getElementById("payment");
	var total = document.getElementById("total");
	var totalinterest = document.getElementById("totalinterest");

	// 假设所有的输入都是合法的，将从input元素中获取输入数据
	// 将百分比格式转换为小数格式，并从年利率转换为月利率
	// 将年度赔付转换为月度赔付
	var principal = parseFloat(amount.value);
	var interest = parseFloat(apr.value) / 100 / 12;
	var payments = parseFloat(years.value) * 12;

	// 现在计算月度赔付的数据
	var x = Math.pow(1 + interest, payments); // Math.pow() 进行幂次运算
	vat monthly = (principal * x * interest) / (x - 1);

	// 如果结果没有超过JavaScript能表示的数字范围，且用户的输入也正确
	// 这里所展示的结果就是合法的
	if (isFinite(monthly)) {
		// 将数据填充至输出字段的位置，四舍五入到小数点后两位数字
		payment.innerHTML = monthly.toFixed(2);
		total.innerHTML = (monthly * payments).toFixed(2);
		totalinterest.innerHTML = ((monthly * payments) - principal).toFixed(2);

		// 将用户的输入数据保存下来，这样在下次访问时也能取到数据
		save(amount.value, apr.value, years.value, zipcode.value);

		// 找到并展示本地放贷人，但忽略网络错误
		try { // 捕获这段代码抛出的所有异常
			getLenders(amount.value, apr.value, years.value, zipcode.value);
		}
		catch(e) { /* 忽略这些异常 */ }



	}
}

// 将用户的输入保存至localStorage对象的属性中
// 这些属性在再次访问时还会继续保存在原位置
// 如果你在浏览器中按照file://URL的方式直接打开本地文件，则无法在某些浏览器中使用存储功能(比如FireFox)
// 而通过HTTP打开文件是可行的
function save(amount, apr, years, zipcode) {
	if (window.localStorage) { // 只有在浏览器支持的时候才运行这里的代码
		localStorage.loan_amount = amount;
		localStorage.loan_apr = apr;
		localStorage.loan_years = years;
		localStorage.loan_zipcode = zipcode;
	}
}


// 将用户的输入发送至服务器端脚本(理论上)将返回一个本地放贷人的链接列表，在这个例子中并没有实现这种查找放贷人的服务
// 但如果该服务存在，该函数会使用它
function getLenders(amount, apr, years, zipcode) {
	// 如果浏览器不支持XMLHttpRequest对象，则退出
	if (!window.XMLHttpRequest) return;

	// 找到要显示放贷人列表的元素
	var ad = document.getElementById("lenders");
	if(!ad) return; // 如果返回为空，则退出

	// 将用户的输入数据进行URL编码，并作为查询参数附加在URL里
	var url = "getLenders.php" + // 处理数据的URL地址
	"?amt=" + encodeURIComponent(amount) + // 使用查询串中的数据
	"?apr=" + encodeURIComponent(apr) +
	"?yrs=" + encodeURIComponent(years) +
	"?zip=" + encodeURIComponent(zipcode);

	// 通过XMLHttpRequest对象来提取返回数据
	var req = new XMLHttpRequest();	// 发起一个新的请求
	req.open("GET", url); // 通过URL发起一个HTTP GET请求
	req.send(null);	// 不带任何正文发送这个请求

	// 在返回数据之前，注册了一个事件处理函数，这个处理函数将会在服务器的响应返回至客户端的时候调用
	// 这种异步编程模型在客户端JavaScript中是非常常见的
	req.noreadystatechange = function() {
		if (req.readyState == 4 && req.status == 200) {
			// 如果代码运行到这里，说明我们得到了一个合法且完整的HTTP响应
			var response = req.responseText; // HTTP响应是以字符串的形式呈现的
			var lenders = JSON.parse(response); // 将其解析为JS数组

			// 将数组中的放贷人对象转换为HTML字符串形式
			var list = "";
			for (var i = 0; i < lenders.length; i++) {
				list += "<li><a href='" + lenders[i].url + "'>" + lenders[i].name + "</a></li>"; /*  */
			}

			// 将数据在HTML元素中呈现出来
			ad.innerHTML = "<ul>" + list + "</ul>";
		}
	}
}



</script>
</body>
</html>